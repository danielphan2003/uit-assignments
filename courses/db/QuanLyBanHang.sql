CREATE DATABASE QuanLyBanHang
USE QuanLyBanHang

-- I.1.

CREATE TABLE KHACHHANG
(
    MAKH char(4),
    HOTEN varchar(40),
    DCHI varchar(50),
    SODT varchar(20),
    NGSINH smalldatetime,
    NGDK smalldatetime,
    DOANHSO money,
    CONSTRAINT PK_KHACHHANG PRIMARY KEY (MAKH),
)

CREATE TABLE NHANVIEN
(
    MANV char(4),
    HOTEN varchar(40),
    SODT varchar(20),
    NGVL smalldatetime,
    CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV),
)

CREATE TABLE SANPHAM
(
    MASP char(4),
    TENSP varchar(40),
    DVT varchar(20),
    NUOCSX varchar(40),
    GIA money,
    CONSTRAINT PK_SANPHAM PRIMARY KEY (MASP),
)

CREATE TABLE HOADON
(
    SOHD int,
    NGHD smalldatetime,
    MAKH char(4),
    MANV char(4),
    TRIGIA money,
    CONSTRAINT PK_HOADON PRIMARY KEY (SOHD),
)

CREATE TABLE CTHD
(
    SOHD int,
    MASP char(4),
    SL int,
    CONSTRAINT PK_CTHD PRIMARY KEY (SOHD, MASP),
)

SET DATEFORMAT DMY

ALTER TABLE HOADON
    ADD CONSTRAINT FK_MAKH FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)

ALTER TABLE HOADON
    ADD CONSTRAINT FK_MANV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE CTHD
    ADD CONSTRAINT FK_SOHD FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD)

ALTER TABLE CTHD
    ADD CONSTRAINT FK_MASP FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)

-- I.2.

ALTER TABLE SANPHAM
    ADD GHICHU varchar(20)

-- I.3.

ALTER TABLE KHACHHANG
    ADD LOAIKH tinyint

-- I.4.

ALTER TABLE SANPHAM
    ALTER COLUMN GHICHU varchar(100)

-- I.5.

ALTER TABLE SANPHAM
    DROP COLUMN GHICHU

-- I.6.

ALTER TABLE KHACHHANG
    ALTER COLUMN LOAIKH varchar(12)

ALTER TABLE KHACHHANG
    ADD CONSTRAINT CHK_LOAIKH CHECK (LOAIKH IN ('Vang lai', 'Thuong xuyen', 'Vip'))

-- I.7.

ALTER TABLE SANPHAM
    ADD CONSTRAINT CHK_DVT CHECK (DVT IN ('cay', 'hop', 'cai', 'quyen','chuc'))

-- I.8.

ALTER TABLE SANPHAM
    ADD CONSTRAINT CHK_GIA CHECK (GIA >= 500)

-- I.9.

ALTER TABLE HOADON
    ADD CONSTRAINT CHK_MUAHANG CHECK (TRIGIA > 0)

-- I.10.

ALTER TABLE KHACHHANG
    ADD CONSTRAINT CHK_NGDK CHECK (NGDK > NGSINH)

-- I.11.

CREATE TRIGGER trg_ins_udt_NgHD ON HoaDon
FOR Insert, Update
AS
BEGIN
    IF (EXISTS (SELECT * FROM KhachHang, inserted 
                WHERE KhachHang.MaKH = inserted.MaKH 
                AND KhachHang.NgDK > inserted.NgHD))
    BEGIN
        PRINT 'Error: NgHD phai >= NgDK'
        ROLLBACK TRANSACTION
    END
END

CREATE TRIGGER trg_upd_NgDK ON KhachHang
FOR Update
AS
BEGIN
    IF (EXISTS (SELECT * FROM HoaDon, inserted
                WHERE HoaDon.MaKH = inserted.MAKH
                AND HoaDon.NgHD < inserted.NgDK))
    BEGIN
        PRINT 'Error: NgHD phai >= NgDK'
        ROLLBACK TRANSACTION
    END
END

-- I.12.

CREATE TRIGGER trg_ins_udt_NgBH ON HoaDon
FOR Insert, Update
AS
BEGIN
    IF (EXISTS (SELECT * FROM NhanVien, inserted 
                WHERE NhanVien.MaNV = inserted.MaKH 
                AND NhanVien.NgVL > inserted.NgHD))
    BEGIN
        PRINT 'Error: NgHD phai >= NgVL'
        ROLLBACK TRANSACTION
    END
END

CREATE TRIGGER trg_upd_NgVL ON NhanVien
FOR Update
AS
BEGIN
    IF (EXISTS (SELECT * FROM HoaDon, inserted
                WHERE HoaDon.MaNV = inserted.MANV
                AND HoaDon.NgHD < inserted.NgVL))
    BEGIN
        PRINT 'Error: NgHD phai >= NgDK'
        ROLLBACK TRANSACTION
    END
END

-- I.13.

CREATE TRIGGER trg_del_CTHD ON CTHD
FOR Delete
AS
BEGIN
    IF ((SELECT COUNT(*) FROM deleted WHERE SoHD = deleted.SoHD)
        = (SELECT COUNT(*) FROM HoaDon, deleted WHERE deleted.SoHD = HoaDon.SoHD))
    BEGIN
        PRINT 'Error: Moi hoa don phai co it nhat 1 CTHD'
        ROLLBACK TRANSACTION
    END
END

-- I.15.

CREATE TRIGGER trg_upd_DoanhSo ON KhachHang
FOR Update
AS
BEGIN
    DECLARE @TongTriGia MONEY, @DoanhSo MONEY

    SELECT @TongTriGia = SUM(TriGia)
    FROM HoaDon, inserted
    WHERE HoaDon.MaKH = inserted.MaKH

    SELECT @DoanhSo = DoanhSo FROM inserted

    IF (@DoanhSo <> @TongTriGia)
    BEGIN
        PRINT('Doanh so cua mot khach hang la tong tri gia cac hoa don khach hang thanh vien do da mua')
        ROLLBACK TRANSACTION
    END
END

-- II.2.

INSERT INTO KHACHHANG
VALUES('KH01', 'Nguyen Van A', '731 Tran Hung Dao, Q5, TpHCM', '8823451', '22/10/1960', '22/07/2006', 13060000)
INSERT INTO KHACHHANG
VALUES('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '908256478', '03/04/1974', '30/07/2006', 280000)
INSERT INTO KHACHHANG
VALUES('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '938776266', '12/06/1980', '08/05/2006', 3860000)
INSERT INTO KHACHHANG
VALUES('KH04', 'Tran Minh Long', '50/34 Le Dai Hanh, Q10, TpHCM', '917325476', '09/03/1965', '10/02/2006', 250000)
INSERT INTO KHACHHANG
VALUES('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM', '8246108', '10/03/1950', '28/10/2006', 21000)
INSERT INTO KHACHHANG
VALUES('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '8631738', '31/12/1981', '24/11/2006', 915000)
INSERT INTO KHACHHANG
VALUES('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '916783565', '06/04/1971', '12/01/2006', 12500)
INSERT INTO KHACHHANG
VALUES('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TpHCM', '938435756', '10/01/1971', '13/12/2006', 365000)
INSERT INTO KHACHHANG
VALUES('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TpHCM', '8654763', '03/09/1979', '14/01/2007', 70000)
INSERT INTO KHACHHANG
VALUES('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TpHCM', '8768904', '02/05/1983', '16/01/2007', 67500)

INSERT INTO NHANVIEN
VALUES('NV01', 'Nguyen Nhu Nhut', '927345678', '13/04/2006')
INSERT INTO NHANVIEN
VALUES('NV02', 'Le Thi Phi Yen', '987567390', '21/04/2006')
INSERT INTO NHANVIEN
VALUES('NV03', 'Nguyen Van B', '997047382', '27/04/2006')
INSERT INTO NHANVIEN
VALUES('NV04', 'Ngo Thanh Tuan', '913758498', '24/06/2006')
INSERT INTO NHANVIEN
VALUES('NV05', 'Nguyen Thi Truc Thanh', '918590387', '20/07/2006')

INSERT INTO SANPHAM
VALUES('BC01', 'But chi', 'cay', 'Singapore', 3000)
INSERT INTO SANPHAM
VALUES('BC02', 'But chi', 'cay', 'Singapore', 5000)
INSERT INTO SANPHAM
VALUES('BC03', 'But chi', 'cay', 'Viet Nam', 3500)
INSERT INTO SANPHAM
VALUES('BC04', 'But chi', 'hop', 'Viet Nam', 30000)
INSERT INTO SANPHAM
VALUES('BB01', 'But bi', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM
VALUES('BB02', 'But bi', 'cay', 'Trung Quoc', 7000)
INSERT INTO SANPHAM
VALUES('BB03', 'But bi', 'hop', 'Thai Lan', 100000)
INSERT INTO SANPHAM
VALUES('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', 2500)
INSERT INTO SANPHAM
VALUES('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', 4500)
INSERT INTO SANPHAM
VALUES('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', 3000)
INSERT INTO SANPHAM
VALUES('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', 5500)
INSERT INTO SANPHAM
VALUES('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', 23000)
INSERT INTO SANPHAM
VALUES('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', 53000)
INSERT INTO SANPHAM
VALUES('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', 34000)
INSERT INTO SANPHAM
VALUES('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', 40000)
INSERT INTO SANPHAM
VALUES('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', 55000)
INSERT INTO SANPHAM
VALUES('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', 51000)
INSERT INTO SANPHAM
VALUES('ST04', 'So tay', 'quyen', 'Thai Lan', 55000)
INSERT INTO SANPHAM
VALUES('ST05', 'So tay mong', 'quyen', 'Thai Lan', 20000)
INSERT INTO SANPHAM
VALUES('ST06', 'Phan viet bang', 'hop', 'Viet Nam', 5000)
INSERT INTO SANPHAM
VALUES('ST07', 'Phan khong bui', 'hop', 'Viet Nam', 7000)
INSERT INTO SANPHAM
VALUES('ST08', 'Bong bang', 'cai', 'Viet Nam', 1000)
INSERT INTO SANPHAM
VALUES('ST09', 'But long', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM
VALUES('ST10', 'But long', 'cay', 'Trung Quoc', 7000)

INSERT INTO HOADON
VALUES(1001, '23/07/2006', 'KH01', 'NV01', 320000)
INSERT INTO HOADON
VALUES(1002, '12/08/2006', 'KH01', 'NV02', 840000)
INSERT INTO HOADON
VALUES(1003, '23/08/2006', 'KH02', 'NV01', 100000)
INSERT INTO HOADON
VALUES(1004, '01/09/2006', 'KH02', 'NV01', 180000)
INSERT INTO HOADON
VALUES(1005, '20/10/2006', 'KH01', 'NV02', 3800000)
INSERT INTO HOADON
VALUES(1006, '16/10/2006', 'KH01', 'NV03', 2430000)
INSERT INTO HOADON
VALUES(1007, '28/10/2006', 'KH03', 'NV03', 510000)
INSERT INTO HOADON
VALUES(1008, '28/10/2006', 'KH01', 'NV03', 440000)
INSERT INTO HOADON
VALUES(1009, '28/10/2006', 'KH03', 'NV04', 200000)
INSERT INTO HOADON
VALUES(1010, '01/11/2006', 'KH01', 'NV01', 5200000)
INSERT INTO HOADON
VALUES(1011, '04/11/2006', 'KH04', 'NV03', 250000)
INSERT INTO HOADON
VALUES(1012, '30/11/2006', 'KH05', 'NV03', 21000)
INSERT INTO HOADON
VALUES(1013, '12/12/2006', 'KH06', 'NV01', 5000)
INSERT INTO HOADON
VALUES(1014, '31/12/2006', 'KH03', 'NV02', 3150000)
INSERT INTO HOADON
VALUES(1015, '01/01/2007', 'KH06', 'NV01', 910000)
INSERT INTO HOADON
VALUES(1016, '01/01/2007', 'KH07', 'NV02', 12500)
INSERT INTO HOADON
VALUES(1017, '02/01/2007', 'KH08', 'NV03', 35000)
INSERT INTO HOADON
VALUES(1018, '13/01/2007', 'KH08', 'NV03', 330000)
INSERT INTO HOADON
VALUES(1019, '13/01/2007', 'KH01', 'NV03', 30000)
INSERT INTO HOADON
VALUES(1020, '14/01/2007', 'KH09', 'NV04', 70000)
INSERT INTO HOADON
VALUES(1021, '16/01/2007', 'KH10', 'NV03', 67500)
INSERT INTO HOADON
VALUES(1022, '16/01/2007', Null, 'NV03', 7000)
INSERT INTO HOADON
VALUES(1023, '17/01/2007', Null, 'NV01', 330000)

INSERT INTO CTHD
VALUES(1001, 'TV02', 10)
INSERT INTO CTHD
VALUES(1001, 'ST01', 5)
INSERT INTO CTHD
VALUES(1001, 'BC01', 5)
INSERT INTO CTHD
VALUES(1001, 'BC02', 10)
INSERT INTO CTHD
VALUES(1001, 'ST08', 10)
INSERT INTO CTHD
VALUES(1002, 'BC04', 20)
INSERT INTO CTHD
VALUES(1002, 'BB01', 20)
INSERT INTO CTHD
VALUES(1002, 'BB02', 20)
INSERT INTO CTHD
VALUES(1003, 'BB03', 10)
INSERT INTO CTHD
VALUES(1004, 'TV01', 20)
INSERT INTO CTHD
VALUES(1004, 'TV02', 10)
INSERT INTO CTHD
VALUES(1004, 'TV03', 10)
INSERT INTO CTHD
VALUES(1004, 'TV04', 10)
INSERT INTO CTHD
VALUES(1005, 'TV05', 50)
INSERT INTO CTHD
VALUES(1005, 'TV06', 50)
INSERT INTO CTHD
VALUES(1006, 'TV07', 20)
INSERT INTO CTHD
VALUES(1006, 'ST01', 30)
INSERT INTO CTHD
VALUES(1006, 'ST02', 10)
INSERT INTO CTHD
VALUES(1007, 'ST03', 10)
INSERT INTO CTHD
VALUES(1008, 'ST04', 8)
INSERT INTO CTHD
VALUES(1009, 'ST05', 10)
INSERT INTO CTHD
VALUES(1010, 'TV07', 50)
INSERT INTO CTHD
VALUES(1010, 'ST07', 50)
INSERT INTO CTHD
VALUES(1010, 'ST08', 100)
INSERT INTO CTHD
VALUES(1010, 'ST04', 50)
INSERT INTO CTHD
VALUES(1010, 'TV03', 100)
INSERT INTO CTHD
VALUES(1011, 'ST06', 50)
INSERT INTO CTHD
VALUES(1012, 'ST07', 3)
INSERT INTO CTHD
VALUES(1013, 'ST08', 5)
INSERT INTO CTHD
VALUES(1014, 'BC02', 80)
INSERT INTO CTHD
VALUES(1014, 'BB02', 100)
INSERT INTO CTHD
VALUES(1014, 'BC04', 60)
INSERT INTO CTHD
VALUES(1014, 'BB01', 50)
INSERT INTO CTHD
VALUES(1015, 'BB02', 30)
INSERT INTO CTHD
VALUES(1015, 'BB03', 7)
INSERT INTO CTHD
VALUES(1016, 'TV01', 5)
INSERT INTO CTHD
VALUES(1017, 'TV02', 1)
INSERT INTO CTHD
VALUES(1017, 'TV03', 1)
INSERT INTO CTHD
VALUES(1017, 'TV04', 5)
INSERT INTO CTHD
VALUES(1018, 'ST04', 6)
INSERT INTO CTHD
VALUES(1019, 'ST05', 1)
INSERT INTO CTHD
VALUES(1019, 'ST06', 2)
INSERT INTO CTHD
VALUES(1020, 'ST07', 10)
INSERT INTO CTHD
VALUES(1021, 'ST08', 5)
INSERT INTO CTHD
VALUES(1021, 'TV01', 7)
INSERT INTO CTHD
VALUES(1021, 'TV02', 10)
INSERT INTO CTHD
VALUES(1022, 'ST07', 1)
INSERT INTO CTHD
VALUES(1023, 'ST04', 6)

SELECT *
INTO SANPHAM1
FROM SANPHAM

SELECT *
INTO KHACHHANG1
FROM KHACHHANG

-- II.3.

UPDATE SANPHAM1
SET GIA = GIA + GIA*5/100
WHERE NUOCSX = "Thai Lan"

-- II.4.

UPDATE SANPHAM1
SET GIA = GIA - GIA*5/100
WHERE NUOCSX = "Trung Quoc" AND SANPHAM.GIA < 10000

-- II.5.

UPDATE KHACHHANG1
SET LOAIKH = "VIP"
WHERE (NGDK < "1/1/2007" AND DOANHSO >= 10000000)
    OR (NGDK >= "1/1/2007" AND DOANHSO >= 2000000)

-- III.8.
SELECT DISTINCT KhachHang.MaKH, HoTen
FROM KhachHang, HoaDon
WHERE 
    KhachHang.MaKH = HoaDon.MaKH 
    AND NgHD = '1/1/2007'

-- III.9.
SELECT SoHD, TriGia
FROM HoaDon, NhanVien
WHERE
    HoaDon.MaNV = NhanVien.MaNV
    AND HoTen = 'Nguyen Van B'
    AND NgHD = '28/10/2006'

-- III.10.
SELECT DISTINCT SanPham.MaSP, TenSP
FROM SanPham, CTHD, KhachHang, HoaDon
WHERE
    CTHD.MaSP = SanPham.MaSP
    AND CTHD.SoHD = HoaDon.SoHD
    AND HoaDon.MaKH = KhachHang.MaKH
    AND HoTen = 'Nguyen Van A'
    AND MONTH(NgHD) = 10 AND YEAR(NgHD) = 2006

-- III.11.
SELECT DISTINCT SoHD
FROM CTHD
WHERE MaSP IN ('BB01', 'BB02')

-- III.12.
SELECT DISTINCT SoHD
FROM CTHD
WHERE 
    MaSP IN ('BB01', 'BB02') 
    AND SL BETWEEN 10 AND 20

-- III.13.
(
    SELECT DISTINCT SoHD
    FROM CTHD
    WHERE MaSP = 'BB01' AND SL BETWEEN 10 AND 20
)
INTERSECT
(
    SELECT DISTINCT SoHD
    FROM CTHD
    WHERE MaSP = 'BB02' AND SL BETWEEN 10 AND 20
)

-- III.14.
SELECT DISTINCT SanPham.MaSP, TenSP
FROM HoaDon, SanPham, CTHD
WHERE
    HoaDon.SoHD = CTHD.SoHD
    AND CTHD.MaSP = SanPham.MaSP
    AND
    (
        NuocSX = 'Trung Quoc'
        OR NgHD = '1/1/2007'
    )


-- III.15.
SELECT MaSP, TenSP
FROM SanPham
WHERE MaSP NOT IN (SELECT MaSP FROM CTHD)

-- III.16.
SELECT MaSP, TenSP
FROM SanPham
WHERE MaSP NOT IN
(
    SELECT MaSP 
    FROM CTHD, HoaDon
    WHERE 
        CTHD.SoHD = HoaDon.SoHD
        AND YEAR(NgHD) = 2006
)

-- III.17.
SELECT MaSP, TenSP
FROM SanPham
WHERE
    NuocSX = 'Trung Quoc'
    AND MaSP NOT IN
    (
        SELECT MaSP 
        FROM CTHD, HoaDon
        WHERE 
            CTHD.SoHD = HoaDon.SoHD
            AND YEAR(NgHD) = 2006
    )

-- III.18.
SELECT SoHD
FROM HoaDon
WHERE
    NOT EXISTS (
        SELECT *
        FROM SanPham
        WHERE
            NuocSX = 'Singapore'
            AND NOT EXISTS (
                SELECT *
                FROM CTHD
                WHERE
                    CTHD.SoHD = HoaDon.SoHD
                    AND CTHD.MaSP = SanPham.MaSP
            )
    )

-- III.19.
SELECT SoHD
FROM HoaDon
WHERE
    YEAR(NgHD) = 2006 
    AND NOT EXISTS (
        SELECT *
        FROM SanPham
        WHERE
            NuocSX = 'Singapore'
            AND NOT EXISTS (
                SELECT *
                FROM CTHD
                WHERE
                    CTHD.SoHD = HoaDon.SoHD
                    AND CTHD.MaSP = SanPham.MaSP
            )
    )

-- III.20.
SELECT COUNT(*)
FROM HoaDon
WHERE MaKH IS NULL

-- III.21.
SELECT COUNT(DISTINCT MaSP)
FROM HoaDon, CTHD
WHERE
    HoaDon.SoHD = CTHD.SoHD
    AND YEAR(NgHD) = 2006

-- III.22.
SELECT MIN(TriGia) Min_TriGia, MAX(TriGia) Max_TriGia
FROM HoaDon

-- III.23.
SELECT AVG(TriGia)
FROM HoaDon
WHERE YEAR(NgHD) = 2006

-- III.24.
SELECT SUM(TriGia)
FROM HoaDon
WHERE YEAR(NgHD) = 2006

-- III.25.
SELECT MAX(TriGia)
FROM HoaDon
WHERE YEAR(NgHD) = 2006

-- III.26.
SELECT DISTINCT HoTen
FROM KhachHang, HoaDon
WHERE 
    HoaDon.MaKH = KhachHang.MaKH
    AND YEAR(NgHD) = 2006
    AND TriGia =
    (
        SELECT MAX(TriGia)
        FROM HoaDon
        WHERE YEAR(NgHD) = 2006
    )

--  III.27.
SELECT TOP 3
    MaKH, HoTen
FROM KhachHang
ORDER BY DoanhSo DESC

-- III.28.
SELECT
    MaSP, TenSP
FROM SanPham
WHERE Gia IN (
    SELECT DISTINCT TOP 3 Gia
    FROM SanPham
    ORDER BY Gia DESC
)

-- III.29.
SELECT
    MaSP, TenSP
FROM SanPham
WHERE
    NuocSX = 'Thai Lan'
    AND Gia IN (
        SELECT DISTINCT TOP 3 Gia
        FROM SanPham
        ORDER BY Gia DESC
    )

-- III.30.
SELECT
    MaSP, TenSP
FROM SanPham
WHERE
    NuocSX = 'Trung Quoc'
    AND Gia IN (
        SELECT DISTINCT TOP 3 Gia
        FROM SanPham
        WHERE NuocSX = 'Trung Quoc'
        ORDER BY Gia DESC
    )

-- III.31.
SELECT TOP 3 *
FROM KhachHang
ORDER BY DoanhSo DESC

-- III.32.
SELECT COUNT(*)
FROM SanPham
WHERE NuocSX = 'Trung Quoc'

-- III.33.
SELECT
    NuocSX, COUNT(*) SoSP
FROM SanPham
GROUP BY NuocSX

-- III.34.
SELECT
    NuocSX, MAX(Gia) Max_Gia, MIN(Gia) Min_Gia, AVG(Gia) TB_Gia
FROM SanPham
GROUP BY NuocSX

-- III.35.
SELECT
    NgHD, SUM(TriGia) DoanhThu
FROM HoaDon
GROUP BY NgHD

--- III.36.
SELECT
    SanPham.MaSP, SUM(SL) SoLuongBan
FROM
    SanPham, HoaDon, CTHD
WHERE
    CTHD.MaSP = SanPham.MaSP
    AND CTHD.SoHD = HoaDon.SoHD
    AND MONTH(NgHD) = 10 AND YEAR(NgHD) = 2006
GROUP BY SanPham.MaSP

-- III.37.
SELECT
    MONTH(NgHD) Thang, SUM(TriGia) DoanhThu
FROM HoaDon
WHERE YEAR(NgHD) = 2006
GROUP BY MONTH(NgHD)

-- III.38.
SELECT SoHD
FROM CTHD
GROUP BY SoHD
HAVING COUNT(DISTINCT MaSP) >= 4

-- III.39.
SELECT SoHD
FROM
    CTHD, SanPham
WHERE
    CTHD.MaSP = SanPham.MaSP
    AND NuocSX = 'Viet Nam'
GROUP BY SoHD
HAVING COUNT(DISTINCT CTHD.MaSP) >= 3

-- III.40.
SELECT
    KhachHang.MaKH, HoTen
FROM
    KhachHang, HoaDon
WHERE KhachHang.MaKH = HoaDon.MaKH
GROUP BY
    KhachHang.MaKH, HoTen
HAVING COUNT(*) >= ALL(
    SELECT COUNT(*)
    FROM HoaDon
    GROUP BY MaKH
)

-- III.41.
SELECT MONTH(NgHD)
FROM HoaDon
WHERE YEAR(NgHD) = 2006
GROUP BY MONTH(NgHD)
HAVING SUM(TriGia) >= ALL(
    SELECT SUM(TriGia)
    FROM HoaDon
    WHERE YEAR(NgHD) = 2006
    GROUP BY MONTH(NgHD)
)

-- III.42.
SELECT TOP 1 WITH TIES
    SanPham.MaSP, TenSP
FROM
    SanPham, CTHD, HoaDon
WHERE 
    SanPham.MaSP = CTHD.MaSP
    AND HoaDon.SoHD = CTHD.SoHD
    AND YEAR(NgHD) = 2006
GROUP BY
    SanPham.MaSP, TenSP
ORDER BY SUM(SL)

-- III.43.
SELECT
    NuocSX, MaSP, TenSP
FROM SanPham SP1
WHERE EXISTS (
    SELECT NuocSX
    FROM SanPham SP2
    GROUP BY NuocSX
    HAVING SP1.NuocSX = SP2.NuocSX
    AND SP1.Gia = MAX(Gia)
)

-- III.44.
SELECT NuocSX
FROM SanPham
GROUP BY NUOCSX
HAVING COUNT(DISTINCT GIA) >= 3

-- III.45.
SELECT *
FROM KhachHang
WHERE MaKH IN (
    SELECT TOP 1 WITH TIES HoaDon.MaKH
    FROM
        (
            SELECT TOP 10 MaKH
            FROM KhachHang
            ORDER BY DoanhSo DESC
        ) AS A
    JOIN HoaDon ON A.MaKH = HoaDon.MaKH
    GROUP BY HoaDon.MaKH
    ORDER BY COUNT(*) DESC
)
